---
layout: single
title: "[블록체인] 블록체인의 블록구조"
categories: blockchain
tag: [블록구조, 논스, 난이도]
toc: true
---

## 비트코인의 블록 구조

블록의 구조는 헤더, 거래로 나누어져 있다.

사실 블록 구조에는 바디라는 필드는 존재하지 않는다. 블록의 구성으로 블록 헤더 외에 블록 크기, 거래 개수도 있으며, 거래를 담은 부분을 주로 바디라고 칭하며 실제로 대부분의 크기를 차지한다.

블록체인이 왜 체인인지, 즉 암호화되어 있다고 하는지는 헤더를 보면 알 수 있다.

### 헤더의 구조
<center>
<img src="../../images/2022-09-13-blockchain_22th/image-20220913154534779.png" alt="image-20220913154534779" style="zoom:33%;" />
</center>
1. **버전**

   비트코인의 어떤 버전을 쓰고 있는지를 표기

2. **이전 블록 헤더 해시**

   블록 헤더 해시는 현재 블록의 해시를 담지 않아 이전 블록 헤더 해시라고 명시하였다. 즉 N번째 블록을 채굴하려는 노드가 N-1번째 블록을 전송받았을 때, 바로 이전 블록(N-1 번째 블록)에 대한 헤더 해시를 직접 계산(정확히는 2번 해시)하여 헤더에 넣는다는 뜻이다.

3. **타임스탬프**

   유닉스 타임(1970년 1월 1일)기준으로 초 단위 해당 블록 채굴 시각을 기록하게 된다.

4. **머클 루트**

   블록체인 내의 각각의 블록에 존재하는 트리이다.

   머클 트리는 트랜잭션들을 각각 해싱하여 2개씩 짝지어서 또 해싱하고를 반복해 최종적으로 하나가 남을 때까지 해싱한 트리이다.

   머클 루트를 이용하여 블록이 가짜인지 진짜인지 판단하기는 쉽다 하지만 블록이 아니라 트랜잭션을 검증해달라고 하면 머클루트는 개별적인 트랜잭션 해시값들이 없기 때문에 풀노드에게 머클 경로를 받음으로써 검증을 해야한다.
<center>
   <img src="../../images/2022-09-13-blockchain_22th/image-20220913155732552.png" alt="image-20220913155732552" style="zoom:33%;" />
</center>
   트랜잭션을 검증할때 풀 노드에게 머클 경로를 요청하면 경로를 알려준다. 그러면 모든 머클 트리를 받지 않고도 손쉽게 Tx7의 해시값을 이용하여 머클 경로를 따라가다 보면 머클 루트와 결괏값이 같은지 알 수 있다.
<center>
   <img src="../../images/2022-09-13-blockchain_22th/image-20220913155750373.png" alt="image-20220913155750373" style="zoom:33%;" />
</center>
   결괏값이 다르면 그 트랜잭션은 잘못된 트랜잭션임이 확실해진다.

5. **난이도 목표**
<center>
   <img src="../../images/2022-09-13-blockchain_22th/image-20220913155912168.png" alt="image-20220913155912168" style="zoom:50%;" />
</center>
   사진속 Difficulty는 난이도를 표기한 형태이다. 이는 해당 블록을 채굴할 때의 난이도를 의미하며, 해당 숫자는 블록의 높이에 따라 자동 설정이 된다.  
   블록을 생성할 때는 해당 난이도에 맞는 **목푯값**이 존재하며 그 목푯값을 '**Bits**'로 표기한다. 이 수는 계수와 지수로 이루어져 있다.

   

   **난이도**와 **목푯값** 사이의 공식

   Difficulty = MAX_TARGET / current_target

   MAX_TARGET 은 첫 난이도로서 비트코인 블록체인이 처음 구동될때 설정된 난이도 값으로 값 1을 의미하며, 4바이트로 '1d00ffff'라고 표기되었다.

   채굴은 목푯값보다 낮은 해시값을 찾는 과정이다.

   Bits 값을 16진법으로 변환하면 0x170b8c8b의 값이 나온다. bits는 첫 1바이트는 지수, 이후 3바이트는 계수이다.

   이는 다음과 같은 특정식을 통해 해시값과 비교할 수 있는 목푯값 형태가 나온다.

   > 목표값 = 계수 * 2 ^ (8 * (지수 - 3))

   여기에 값을 대입하고 이를 10진법으로 변환하고 다시 16진법으로 변환하면 비교 가능한 목표 해시값이 나오게 된다.

   

   특정 길이의 공간에서 앞자리의 0의 숫자가 길수록 난이도는 높다고 표현할 수 있다. 0의 숫자를 1비트 증가시킬 때마다 검색 공간은 반으로 줄어들기 때문이다.  
   즉, 해시를 통해 나올 수 있는 결괏값은 무수히 많은 경우의 수를 가지지만, 난이도가 높을수록 작은 숫자(목푯값)보다 작은 값을 찾는 과정이 어렵게 된다. 이를 비유로 설명하면 방안에서 침대보다 작은 물건 찾기(나이도가 낮은, 즉 목표값이 높은 값) 보다 양말보다 작은 물건 찾기(난이도가 높은, 목푯값이 낮은)가 어렵다  흔히 주사위를 예시로 드는 것과 같은 개념이다.

   결국 채굴은 목푯값보다 낮은 현재 블록 헤더 해시값을 찾는 과정으로 설명할 수 있다. 블록 헤더 해시는 해시값이기 때문에 점진적으로 증가하거나 낮아지는 형태가 아닌 무작위로 결괏값을 띈다는 사실을 인지하면, 채굴이 왜 어려운지 그리고 왜 무작위인지에 대해 알 수 있다.

6. **Nonce(논스)**

   이 모든 랜덤한 과정에 있어서 유일하게 변하는 값은 논스이다. 논스는 한번만 쓰이는 숫자이며 Number + Once 라고 생각하면 더 쉽게 이해할 수 있다. 논스는 0부터 시작하여 무수히 많은 숫자까지 증가시키며 목푯값보다 낮은 해시 결괏값을 찾도록 쓰이며, 결국 모든 채굴의 과정은 논스로 인해 좌지우지되게 된다.

   논스를 제외한 헤더의 구조를 살펴봤을 때, 모든 것은 주어져 있다고 볼 수 있다. 버전과 타임 스탬프는 채굴하는 순간의 값이며, 난이도 비트는 자동으로 설정되어 있다. 이외에 이전 블록 헤더 해시와 머클 루트는 단순 계산으로 구할 수 있다.

   채굴자들은 채굴하고자 하는 블록을 위해 우선 바디(트랜잭션)을 준비해 놓는다. 어떠한 노드에 의해 이전 블록이 완성되어 전달받자마자 해당 블록 헤더 해시를 계산하여 논스를 제외한 모든 헤더의 모든 값을 준비하게 된다.

   난이도 조절을 10분에 블록 1개가 적정하다고 설계 되었고 그를 위한 난이도 조절 방법은 다음과 같다.

   > Next Difficulty = current dfficulty * 2 weeks / T(Time in which previous 2016 blocks found)

   비트코인은 2016개의 블록을 주기로, 이전 주기에서 2016개의 블록이 형성될때까지의 시간을 체크하여 새로운 난이도를 조절한다. 예를 들어 2016개의 블록이 형성될 때까지 블록 1개 생성당 평균 5분이 걸렸다면 난이도가 높아지고 15분이 걸렸다면 난이도가 낮아지는 방식이다.

### 난이도 및 논스 추가

#### Block Hash

블록의 식별자 역할을 하는 블록 해시는 6가지의 블록 헤더 정보를 입력값으로 하고 여기에 SHA256 해시 함수를 2회 적용해서 계산되는 값으로 32바이트의 숫자값이다. 이름은 블록 해시이지만, 실제로는 그 값은 블록 전체를 해시한 값이 아니라 블록 헤더를 해시한 값이다.
<center>
<img src="../../images/2022-09-13-blockchain_22th/image-20220913164032657.png" alt="image-20220913164032657" style="zoom:33%;" />
</center>
거래 정보의 해시값은 해당 거래가 포함된 블록의 머클 해시 계산에 입력값으로 사용되고, 머클 해시는 블록 해시의 계산에 입력값으로 사용된다. 블록 해시는 다음 블록(A라 하면)의 직접 블록의 해시 값으로 저장되며, 직전 블록의 해시는 A 블록의 블록 헤더 정보로서, A 블록의 블록 해시를 계산하는데 입력값으로 사용된다.

따라서 거래 정보가 변경되면 머클 해시가 변경되고, 머클 해시가 변경되면 블록 해시가 변경되고, 블록 해시의 변경은 다음 블록의 블록 해시 변경으로 연쇄적으로 이어지게 된다. 그리고 블록 해시는 작업 증명의 해답(논스값)을 찾아내야 구할 수 있으므로, 거래 정보를 변경한 블록부터 그 이후의 모든 블록을 순서대로 다시 채굴해야 한다.

#### 논스와 작업 난이도

##### 논스값의 계산

논스값은 이 논스값을 입력값 중의 하나로 이용해 계산되는 **블록 해시값이 특정 숫자보다 작아지게 하는 값**을 말한다.

그리고 해시 함수의 특성상, 어떤 해시값(A)을 결과로 나오게 하는 입력값을 찾으려면 A에서 역산하는 방식으로는 찾을 수 없고, 결과가 A가 나올 때까지 무작위로 입력값을 계속 바꿔가면서 찾아낼 수 밖에 없다.

그 입력값을 바꿀 수 있는 유일한 통로가 바로 논스이다. 다시 말해, 블록 헤더란에 포함된 6가지 정보 중에서 확정되지 않아서 값을 바꿀 수 있는 유일한 항목이 논스이다.
<center>
<img src="../../images/2022-09-13-blockchain_22th/image-20220913165214387.png" alt="image-20220913165214387" style="zoom:33%;" />
</center>
이 논스값을 1씩 증가시키면서 반복적으로 계산한 블록 해시값이 특정 숫자보다 작은 값이 나오면, 그때의 논스값으로 계산한 블록 해시가 그 블록의 블록 해시로 확정되고, 블록 해시라는 식별자를 얻은 그 블록은 새로운 블록으로서 블록체인에 추가되며 작업이 완료된다.

작업 증명 성공 여부의 기준은 작업 난이도(채굴 난이도)에 의해 정해진다.

##### 작업 난이도

블록 해시가 특정 숫자보다 낮게 나올 때의 논스값을 찾아내는 것이 작업증명이다. 작업 난이도는 논스 계산의 어려운 정도를 나타내고, 작업 난이도는 블록 헤더 정보에서 **난이도 비트(Bits)**라는 값으로 조절된다.

앞에서 블록해시는 32바이트의 숫자라고 했는데 이해를 쉽게 하기 위해 블록 해시를 부호 없는 1바이트의 숫자라고 가정해보면 1바이트의 숫자값을 블록 해시값으로 산출하는 해시 함수는 0~255 사이의 값을 결과로 산출한다.

블록 해시가 128보다 작아야 한다고 하면 50%의 확률이고 64보다 작아야하면 25% 확률로 논수값을 구할 수 있게 되고 이 50, 25라는 특정 숫자가 바로 블록 헤더 정보의 **난이도 비트**이다.

### 이더리움 논스

1. 모든 거래(Transaction)은 일회성이다.
2. 논스는 계정에서 보내는 트랜잭션에 할당된 번호이다.
   - 거래(Transaction)를 전송 시 논스는 1씩 증가한다.
   - 논스는 계정에서 유일하다. 동일한 논스는 존재하지 않는다.

#### 논스 규칙

- 트랜잭션은 순서대로 이루어져야 한다.

- 순번을 건너뛰지 않는다.

  논스가 3인 트랜잭션 전송 시, 현재 계정의 논스가 1일 경우 트랜잭션이 처리되지 않고 Transaction Pool Queue에 남아있게 된다. 그리고 차후에 논스가 2인 트랜잭션을 전송하였을 경우 2,3 이 연달아 처리된다.

#### 논스가 필요한 이유

논스는 중복되지 않고 순서가 있기 때문에, 같은 논스를 가진 여러 트랜잭션 전송이 발생할 경우엔 해당 논스 중 제일 높은 가스비를 지불한 트랜잭션이 처리된다. 이더리움에서는 이러한 방법으로 이중 지불 문제를 방지한다.

**논스를 통해 트랜잭션 취소?**

트랜잭션이 네트워크에 정상적으로 전파되었다면 취소하는 방법은 존재하지 않는다. 그러나 논스를 기존보다 높게 설정되었거나, 너무 낮은 가스를 지불하였을 경우 아직 Transaction Pool에 남아있는 상태(Pending)이라면 논스를 이용하여 해당 트랜잭션을 재전송하여 취소된 효과를 볼 수 있다.