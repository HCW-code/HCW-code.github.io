---
layout: single
title: "[Database] Cmarket Database ì˜ˆì œ"
categories: database
tag: [sql, database, node.js]
toc: true
---

### **schema.sql**

- ##### ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸” ìƒì„± ë° êµ¬ì¡°

```sql
CREATE TABLE users (
  id INT AUTO_INCREMENT,
  username varchar(255),
  PRIMARY KEY (id)
);

CREATE TABLE items (
  id INT AUTO_INCREMENT,
  name varchar(255),
  price INT,
  image varchar(255),
  PRIMARY KEY (id)
);

CREATE TABLE orders (
  id INT AUTO_INCREMENT,
  user_id INT,
  total_price INT,
  created_at datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id)
);

CREATE TABLE order_items (
  id INT AUTO_INCREMENT,
  order_id INT,
  item_id INT,
  order_quantity INT,
  PRIMARY KEY (id)
);

ALTER TABLE orders ADD FOREIGN KEY (user_id) REFERENCES users (id);

ALTER TABLE order_items ADD FOREIGN KEY (order_id) REFERENCES orders (id);

ALTER TABLE order_items ADD FOREIGN KEY (item_id) REFERENCES items (id);
```

### **app.js**

- ##### routerë¥¼ ì‚¬ìš©í•œë‹¤ê³  ëª…ì‹œ

```javascript
const express = require("express");
const indexRouter = require("./routes"); //routes ëª¨ë“ˆì„ ê°€ì ¸ì˜´
const cors = require("cors");
const morgan = require("morgan");
const app = express();
const port = process.env.PORT || 4000;

app.use(
  morgan("      :method :url :status :res[content-length] - :response-time ms")
);
app.use(cors());
app.use(express.urlencoded({ extended: true }));
app.use(express.json());
app.use("/", indexRouter); // indexRouterë¥¼ ì´ìš©

const server = app.listen(port, () => {
  console.log(`      ðŸš€ Server is starting on ${port}`);
});

module.exports = server;
```

### **index.js **

- ##### routerë¥¼ ê° jsíŒŒì¼ë¡œ ì—°ê²°

```javascript
const express = require('express');
const router = express.Router();
const itemsRouter = require('./items');
const usersRouter = require('./users');
// TODO: Endpointì— ë”°ë¼ ì ì ˆí•œ Routerë¡œ ì—°ê²°í•´ì•¼ í•©ë‹ˆë‹¤.
router.use('/items', itemsRouter); //urlì—°ê²°
router.use('/users', usersRouter); //urlì—°ê²°

module.exports = router;
```

### **item.js**

- ##### controllerì— ìžˆëŠ” getí•¨ìˆ˜ë¥¼ ì—°ê²°

```javascript
const router = require('express').Router();
const controller = require('./../controllers');

// GET /items Routerì™€ Controllerë¥¼ ì—°ê²°í•©ë‹ˆë‹¤.
router.get('/', controller.items.get);

module.exports = router;
```

### **users.js**

- ##### controllerì— ìžˆëŠ” get, post í•¨ìˆ˜ë¥¼ ì—°ê²°(ì´ë•Œ ë„˜ê²¨ì£¼ëŠ” ê°’ë„ urlì— ìž‘ì„±í•´ì•¼í•¨)

```javascript
const router = require('express').Router();
const controller = require('./../controllers');

router.get('/:userId/orders', controller.orders.get); //userIdê°’ì„ paramsë¡œ ë„˜ê²¨ì¤€ë‹¤
router.post('/:userId/orders', controller.orders.post);	//userIdê°’ì„ paramsë¡œ ë„˜ê²¨ì¤€ë‹¤

module.exports = router;
```

### **controllers/index.js**

- ##### ìš”ì²­ì„ í•˜ê³  ê·¸ì— ë”°ë¥¸ ê²°ê³¼ë‚˜ ì—ëŸ¬ë¥¼ í´ë¼ì´ì–¸íŠ¸ì— ë°˜í™˜í•œë‹¤.

```javascript
const models = require('../models');

module.exports = {
  items: {
    get: (req, res) => {
      models.items.get((error, result) => {
        if (error) {
          res.status(500).send('Internal Server Error');
        } else {
          res.status(200).json(result);
        }
      });
    },
  },
  orders: {
    get: (req, res) => {
      const userId = req.params.userId;

      if (!userId) {
        return res.status(401).send('Unauthorized user.');
      } else {
        models.orders.get(Number(userId), (error, result) => {
          if (error) {
            res.status(500).send('Internal Server Error');
          } else {
            res.status(200).json(result);
          }
        });
      }
    },
    post: (req, res) => {
      const userId = req.params.userId;
      const { orders, totalPrice } = req.body;

      if (!orders || !totalPrice || !userId) {
        return res.status(400).send('Bad request.');
      } else {
        models.orders.post(
          Number(userId),
          orders,
          totalPrice,
          (error, result) => {
            if (error) {
              res.status(500).send('Internal Server Error');
            } else {
              res.status(201).send('Order has been placed.');
            }
          }
        );
      }
    },
  },
};
```

### **models/index.js**

- ##### ìš”ì²­ì„ ë°›ì€ í›„ DBì— ì ‘ê·¼í•˜ì—¬ ìž‘ì—… ìˆ˜í–‰ í›„ ê·¸ì— ë”°ë¥¸ ê²°ê³¼ ë°˜í™˜

```javascript
const db = require('../db');

module.exports = {
  items: {
    get: (callback) => {
      // TODO: Cmarketì˜ ëª¨ë“  ìƒí’ˆì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ë¥¼ ìž‘ì„±í•˜ì„¸ìš”
      const queryString = `SELECT * FROM items`;

      db.query(queryString, (error, result) => {
        callback(error, result);
      });
    },
  },
  orders: {
    get: (userId, callback) => {
      // TODO: í•´ë‹¹ ìœ ì €ê°€ ìž‘ì„±í•œ ëª¨ë“  ì£¼ë¬¸ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ë¥¼ ìž‘ì„±í•˜ì„¸ìš”
      const queryString = `SELECT orders.id, orders.created_at, orders.total_price, items.name, items.price, items.image, order_items.order_quantity FROM items
      INNER JOIN order_items ON (order_items.item_id = items.id)
      INNER JOIN orders ON (orders.id = order_items.order_id)
      WHERE (orders.user_id = ?)`;

      const params = [userId];

      db.query(queryString, params, (error, result) => {
        callback(error, result);
      });
    },
    post: (userId, orders, totalPrice, callback) => {
      // TODO: í•´ë‹¹ ìœ ì €ì˜ ì£¼ë¬¸ ìš”ì²­ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ìƒì„±í•˜ëŠ” í•¨ìˆ˜ë¥¼ ìž‘ì„±í•˜ì„¸ìš”
      const queryString = `INSERT INTO orders (user_id, total_price) VALUES (?, ?)`;
      const params = [userId, totalPrice];

      db.query(queryString, params, (error, result) => {
        if (result) {
          const queryString = `INSERT INTO order_items (order_id, item_id, order_quantity) VALUES ?;`;
          const params = orders.map((order) => [
            result.insertId,
            order.itemId,
            order.quantity,
          ]);

          return db.query(queryString, [params], (error, result) => {
            callback(error, result);
          });
        }
        callback(error, null);
      });
    },
  },
};
```

