---
layout: single
title: "Docker"
categories: docker
tag: [docker]
toc: true

---

### 컨테이너(Container)

개발자들은 물자의 수송에 획기적인 단축을 가져다 준 컨테이너 기술을 "소프트웨어 수송, 즉 배포"에 사용하려고 생각했고 그 결과로 리눅스 컨테이너(lxc)라는 것을 만들어냈다.

리눅스 컨테이너 기술은 그 자체로 훌륭하고 완성된 기술이었지만 애플리케이션을 쉽게 컨테이너화할 수 있는 생태계 혹은 커뮤니티가 없었다. 2013년에 등장한 도커(Docker)는 바로 Docker Hub라는 소프트웨어 저장소와 함께 빠르게 성장했고, 그 결과 개발자들은 쉽게 애플리케이션을 포장하고, 컨테이너 방식으로 실행할 수 있게 되었다.

### 컨테이너 방식의 장점

1. 의존성 충돌 문제를 해결해준다.

   어떤 애플리케이션은 해당 애플리케이션을 실행하기 위해 반드시 어떤 환경이 구축되어야 한다.

   우리는 이와 같이 어떤 프로그램(A) 실행에 다른 프로그램(B)이 반드시 필요한 경우, "프로그램 A는 프로그램 B에 의존 관계를 가지고 있다"고 말한다.

   그리고 다른 두 프로그램이 각각 다른 버전의 프로그램에 의존한다면 이런상황을 우리는 "의존성이 충돌한다"라고 말한다.

   컨테이너 기술은 이 문제를 해결할 수 있다. 컨테이너 기술은 애플리케이션을 컨테이너 내에 구성한다. 즉, 컨테이너에서 실행 중인 애플리케이션은 어떠한 의존성도 공유하지 않고 각자 고유의 의존성을 포함하고 있다는 뜻이다.
   <center>
   <img src="../../images/2022-08-22-docker_first/image-20220821162722355.png" alt="image-20220821162722355" style="zoom: 33%;" />
   </center>
   컨테이너는 다음을 격리하고 자원들을 독립적으로 소유한다.

   1. 프로세스
      - 특정 컨테이너에서 작동하는 프로세스는 기본적으로 그 컨테이너 안에서만 액세스 할 수 있다.
      - 컨테이너 안에서 실행되는 프로세스는 다른 컨테이너의 프로세스에게 영향을 줄 수 없습니다.
   2. 네트워크
      - 기본으로 컨테이너 하나에 하나의 IP주소가 할당되어 있다.
   3. 파일 시스템
      - 컨테이너 안에서 사용되는 파일 시스템은 구획화되어 있다. 그래서 해당 컨테이너에서의 명령이나 파일 들의 액세스를 제한할 수 있다.

2. 개발과 배포 환경을 일치시킨다.

   여러 개발자가 하나의 애플리케이션을 만들기 위해 보통 비슷한 개발 환경을 구축하기 마련이다. 특정 버전 이상의 Node.js, 특정 버전의 MySQL 등을 개발자 각자가 본인의 운영체제에 설치하고 그 후에 개발을 진행한다. 하지만 보통의 경우 그 과정이 빠르게 진행되지 않는다.

   도커는 이러한 문제를 해결해준다. 도커가 실행중이라면 어떠한 운영체제든 상관없이 다음 명령어로 즉시 PostgreSQL을 설치하고 실행할 수 있다.

   ```shell
   docker run --name postgres -e POSTGRES_PASSWORD=mysecret -d postgres
   ```

   위는 단일 소프트웨어 패키지 하나의 사례를 들었지만, 애플리케이션 구성 자체가 컨테이너화되면(이때 보통 Docker Compose라는 툴 사용) YAMl 파일 하나 + 명령어 하나로 모든 애플리케이션 실행 환경 구성이 완료되는 기적을 볼 수 있다.

   ```shell
   docker-compose up
   ```

   따라서 도커는 다음 문제를 해결할 수 있다.

   - OS에 상관없이 즉시 애플리케이션 실행 환경을 만들 수 있다.
   - 개발을 컨테이너 위에서 진행할 경우, 모든 개발팀이 동일한 환경 하에 개발을 진행할 수 있다.

   **배포시의 문제**

   실행 및 개발 환경의 일치 이슈는 서비스 배포 환경에서도 동일하게 적용될 수 있다. 웹 서비스의 배포란 "어떤 애플리케이션이 특정 런타임 환경 위에서 실행되고, 사용자에게 이를 제공한다"는 것인데, 이는 앞서 말한 실행환경 구성과 본질적으로 다를것이 없다. 그저 서비스를 인터넷상에 공개적으로 노출하느냐, 내 컴퓨터 상에서 프라이빗하게 작동하느냐의 차이일 뿐이다.

   그래서 이제는 배포의 패러다임이 달라졌다. 서버에 파일 하나하나를 업로드하는 방식은 마치 물자를 하나하나 배에 옮기는 이전의 방식이라고 볼 수 있다. 서버도 이제는 컨테이너에 담긴 애플리케이션을 실행하는 방식으로 서비스를 제공한다.

   따라서 Amazon Web Service의 EC2 상에 도커를 설치하거나, 또는 좀 더 편리하게 도커 컨테이너를 EC2 서버에서 실행할 수 있게 하는 서비스인 ECS를 이용하여 보다 쉽게 애플리케이션을 배포할 수 있다.
   <center>
   <img src="../../images/2022-08-22-docker_first/image-20220821164412265.png" alt="image-20220821164412265" style="zoom: 33%;" />
   </center>
3. 수평 확장을 쉽게 해준다, 각 서버에 새로운 내용을 배포하기 쉽게 만들어준다.

   우리가 매일같이 사용하는 글로벌 웹 서비스는 전 세계인들이 사용하므로 그 트래픽이 매우 많다. 예를 들어 지금 이시간에도 전세계의 수많은 사람들이 google.com 에 접속할 텐데, 수많은 사람들이 검색 서버라는 단 하나의 컴퓨터에 접속하고 있는것은 아니다.

   서비스 제공자들은 이러한 트래픽 분산을 위해 프록시 서버를 운영하며, 프록시 서버는 여러 대의 동일한 검색 서버 중 한 군데를 이용할 수 있도록 돕는다.(이러한 서버를 리버스 프록시의 한 종류인 "로드 밸런서"라고 부른다.)
   <center>
   <img src="../../images/2022-08-22-docker_first/image-20220821165523048.png" alt="image-20220821165523048" style="zoom: 33%;" />
   </center>
   컨테이너 기술의 가장 큰 장점은 실행환경의 일치이다. 더 많은 트래픽으로 인한 서버 증설에 컨테이너 기술은 아주 활발하게 이용되고 있다. 동일한 애플리케이션 구성(이미지)을 바탕으로 새로운 서버에 해당 애플리케이션을 컨테이너로 실행하고 로드 밸런서에 이 서버를 추가하기만 하면된다.(AWS는 서버를 만들고 삭제하는 일을 자동으로 해준다.)

   이러한 기술을 응용하여, 새로운 버전의 애플리케이션을 여러 서버 중 몇 대에만 운영하여 테스트하는 방법도 가능하다. 이를 통해 새 버전의 애플리케이션에서 발생할 수 있는 문제들을 미리 확인하고, 이러한 문제가 사용자 전체에게 영향을 끼치지 않도록 만들 수도 있다.
   <center>
   <img src="../../images/2022-08-22-docker_first/image-20220821165810756.png" alt="image-20220821165810756" style="zoom: 33%;" />
   </center>
   쿠버네트시와 같이 "오케스트레이션 도구"라고 부르는 것들이 이러한 일을 해주는 도구이다. 이는 결국 컨테이너 기술 덕분하에 가능한 것이다.

### Docker 핵심 키워드

#### 컨테이너

컨테이너는 애플리케이션이 의존성, 네트워크 환경, 파일 시스템에 구애받지 않고, 도커라는 기술 위에 실행될 수 있도록 만든 애플리케이션 상자이다.

#### 이미지

실행되는 모든 컨테이너는 이미지로부터 생성된다. 이미지는 애플리케이션 및 애플리케이션 구성을 함께 담아놓은 템플릿으로, 이를 이용해 즉시 컨테이너를 만들 수 있다.

이미지를 이용해 여러 개의 컨테이너를 생성할 수 있다. 이를 이용해 앞서 설명한 애플리케이션의 수평 확장이 가능하다.

이미지는 기본 이미지(base image)로부터 (마치 git을 사용하는 것처럼) 변경 사항을 추가/커밋해서 또 다른 이미지를 만들 수도 있다. 예를 들어 node.js로 작성된 애플리케이션을 이미지로 만들고 싶은 경우, nodejs 이미지를 기본 이미지로 삼고 내가 만든 애플리케이션을 추가해 넣고, 이미지화할 수 있다.

#### 레지스트리

이미지는 레지스트리에 저장된다. 대표적인 이미지 레지스트리로는 Docker Hub, Amazon ECR이 있다. 도커 CLI에서 이미지를 이용해 컨테이너를 생성할 때, 호스트 컴퓨터에 이미지가 존재하지 않는다면, 기본 레지스트리로부터 다운받게 된다.